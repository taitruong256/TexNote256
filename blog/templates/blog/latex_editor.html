{% extends 'base.html' %}
{% block content %}
<style>
  #latexEditor, #preview {
    min-height: 300px;
    max-height: 65vh;
    height: 65vh;
    overflow-y: auto;
  }
</style>
<div class="row" style="height:80vh;">
  <!-- Sidebar: file list -->
  <div class="col-2 border-end" style="overflow-y:auto;">
    <h6 class="mt-2">Files</h6>
    <ul class="list-group">
      {% for f in files %}
        <li class="list-group-item file-item" data-filename="{{ f }}" style="cursor:pointer;">{{ f }}</li>
      {% endfor %}
    </ul>
    <form id="uploadForm" enctype="multipart/form-data" class="mt-3">
      <input type="file" name="image" accept="image/*" class="form-control mb-2" />
      <button type="submit" class="btn btn-sm btn-primary w-100">Upload Image</button>
    </form>
  </div>
  <!-- Editor -->
  <div class="col-5 px-0 d-flex flex-column" style="height:100%;">
    <textarea id="latexEditor" class="form-control flex-grow-1" style="font-family:monospace;"></textarea>
    <div id="imagePreview" class="text-center my-2"></div>
    <div class="d-flex mt-2">
      <button id="saveBtn" class="btn btn-success me-2">Save</button>
      <button id="renderBtn" class="btn btn-info">Render</button>
    </div>
  </div>
  <!-- Preview -->
  <div class="col-5 border-start px-0 d-flex flex-column" style="height:100%;">
    <div id="preview" class="p-3 bg-white flex-grow-1"></div>
  </div>
</div>
<script>
let currentFile = null;
// Load file content
$('.file-item').on('click', function() {
  const filename = $(this).data('filename');
  currentFile = filename;
  if (filename.match(/\.(png|jpg|jpeg|gif)$/i)) {
    // Nếu là ảnh, hiển thị ảnh ở giữa
    $('#latexEditor').val('');
    $('#imagePreview').html('<img src="/latex/' + filename + '" class="img-fluid" style="max-height:300px;"/>');
    $('#preview').html('');
  } else {
    // Nếu là file .tex, load nội dung
    $.get('{% url 'latex_load_file' %}', {filename}, function(data) {
      $('#latexEditor').val(data.content);
      $('#imagePreview').html('');
      $('#preview').html('');
    });
  }
});
// Save file
$('#saveBtn').on('click', function() {
  if (!currentFile) { alert('Chọn file để lưu!'); return; }
  $.post('{% url 'latex_save_file' %}', {
    filename: currentFile,
    content: $('#latexEditor').val(),
    csrfmiddlewaretoken: '{{ csrf_token }}'
  }, function() { alert('Đã lưu!'); });
});
// Render preview (nội bộ)
$('#renderBtn').on('click', function() {
  const latex = $('#latexEditor').val();
  $.post('{% url 'latex_render_html' %}', {
    latex: latex,
    csrfmiddlewaretoken: '{{ csrf_token }}'
  }, function(data) {
    $('#preview').html(data.html);
  });
});
// Upload image
$('#uploadForm').on('submit', function(e) {
  e.preventDefault();
  var formData = new FormData(this);
  $.ajax({
    url: '{% url 'latex_upload_image' %}',
    type: 'POST',
    data: formData,
    processData: false,
    contentType: false,
    success: function(data) { alert('Đã upload: ' + data.filename); location.reload(); },
    error: function() { alert('Lỗi upload!'); }
  });
});
</script>
{% endblock %}
